<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NameThat - Spotify Web Playback Demo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: white;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .status {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .login-btn {
            background: #1DB954;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 20px auto;
        }
        
        .login-btn:hover {
            background: #1ed760;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(29, 185, 84, 0.4);
        }
        
        .track-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        .album-art {
            width: 200px;
            height: 200px;
            border-radius: 10px;
            margin: 0 auto 20px;
            display: block;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #1DB954;
            width: 0%;
            transition: width 0.1s ease;
        }
        
        .time-display {
            text-align: center;
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .error {
            background: rgba(255, 0, 0, 0.2);
            color: #ffcccc;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #ff0000;
        }
        
        .success {
            background: rgba(0, 255, 0, 0.2);
            color: #ccffcc;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #00ff00;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ NameThat - Spotify Web Playback</h1>
        
        <div class="status" id="status">
            <h3>Status</h3>
            <p id="statusText">Ready to connect to Spotify</p>
        </div>
        
        <button class="login-btn" id="loginBtn" onclick="login()">
            Connect to Spotify
        </button>
        
        <div id="playerSection" style="display: none;">
            <div class="track-info" id="trackInfo">
                <img id="albumArt" class="album-art" src="" alt="Album Art">
                <h3 id="trackName">No track playing</h3>
                <p id="artistName">Unknown Artist</p>
                <p id="albumName">Unknown Album</p>
            </div>
            
            <div class="controls">
                <button class="control-btn" id="playBtn" onclick="togglePlay()" disabled>
                    ‚ñ∂Ô∏è Play
                </button>
                <button class="control-btn" id="pauseBtn" onclick="pause()" disabled>
                    ‚è∏Ô∏è Pause
                </button>
                <button class="control-btn" id="nextBtn" onclick="nextTrack()" disabled>
                    ‚è≠Ô∏è Next
                </button>
                <button class="control-btn" id="prevBtn" onclick="previousTrack()" disabled>
                    ‚èÆÔ∏è Previous
                </button>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div class="time-display" id="timeDisplay">
                0:00 / 0:00
            </div>
        </div>
        
        <div id="errorSection" style="display: none;" class="error">
            <h3>‚ö†Ô∏è Important Note</h3>
            <p>This demo requires:</p>
            <ul>
                <li>A Spotify Premium account</li>
                <li>An active Spotify session in another tab/window</li>
                <li>Your device to be registered with Spotify</li>
            </ul>
            <p><strong>Free accounts cannot use the Web Playback SDK.</strong></p>
        </div>
    </div>

    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
        let player;
        let deviceId;
        let currentTrack = null;
        let isPlaying = false;
        
        // Spotify Web Playback SDK configuration
        // TODO: Replace with your new Web Playback app's client ID
        const clientId = '6a66b9a319ad4baba3bf7b2309af5739';
        const redirectUri = 'http://127.0.0.1:8080/spotify_web_playback_demo.html';
        
        // Scopes needed for Web Playback SDK
        const scopes = [
            'streaming',
            'user-read-email',
            'user-read-private',
            'user-library-read',
            'user-library-modify',
            'user-read-playback-state',
            'user-modify-playback-state'
        ];
        
        function login() {
            const authUrl = `https://accounts.spotify.com/authorize?client_id=${clientId}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scopes.join(' '))}&show_dialog=true`;
            window.location.href = authUrl;
        }
        
        function updateStatus(message, isError = false) {
            const statusText = document.getElementById('statusText');
            const status = document.getElementById('status');
            
            statusText.textContent = message;
            
            if (isError) {
                status.style.background = 'rgba(255, 0, 0, 0.2)';
            } else {
                status.style.background = 'rgba(255, 255, 255, 0.2)';
            }
        }
        
        function showError(message) {
            const errorSection = document.getElementById('errorSection');
            const errorText = errorSection.querySelector('p');
            errorText.textContent = message;
            errorSection.style.display = 'block';
        }
        
        function initializePlayer() {
            updateStatus('Initializing Spotify Web Playback SDK...');
            
            window.onSpotifyWebPlaybackSDKReady = () => {
                player = new Spotify.Player({
                    name: 'NameThat Web Player',
                    getOAuthToken: cb => { cb(getAccessToken()); }
                });
                
                // Error handling
                player.addListener('initialization_error', ({ message }) => {
                    console.error('Failed to initialize:', message);
                    updateStatus('Failed to initialize player: ' + message, true);
                    showError('Failed to initialize Spotify player. This usually means you need a Premium account or there\'s no active Spotify session.');
                });
                
                player.addListener('authentication_error', ({ message }) => {
                    console.error('Failed to authenticate:', message);
                    updateStatus('Authentication failed: ' + message, true);
                });
                
                player.addListener('account_error', ({ message }) => {
                    console.error('Failed to validate Spotify account:', message);
                    updateStatus('Account validation failed: ' + message, true);
                    showError('Your Spotify account doesn\'t support Web Playback. You need a Premium account.');
                });
                
                player.addListener('playback_error', ({ message }) => {
                    console.error('Failed to perform playback:', message);
                    updateStatus('Playback error: ' + message, true);
                });
                
                // Playback status updates
                player.addListener('player_state_changed', state => {
                    if (state) {
                        currentTrack = state.track_window.current_track;
                        isPlaying = !state.paused;
                        updateTrackInfo();
                        updatePlaybackControls();
                    }
                });
                
                // Ready
                player.addListener('ready', ({ device_id }) => {
                    console.log('Ready with Device ID', device_id);
                    deviceId = device_id;
                    updateStatus('Connected to Spotify! Ready to play music.');
                    document.getElementById('playerSection').style.display = 'block';
                    document.getElementById('loginBtn').style.display = 'none';
                });
                
                // Not Ready
                player.addListener('not_ready', ({ device_id }) => {
                    console.log('Device ID has gone offline', device_id);
                    updateStatus('Device went offline', true);
                });
                
                // Connect to the player
                player.connect();
            };
        }
        
        function getAccessToken() {
            // This function is called by the Web Playback SDK
            // It should only return a token, not redirect
            const storedToken = localStorage.getItem('spotify_token');
            if (storedToken) {
                return storedToken;
            }
            
            // If no token, return null - the SDK will handle the error
            console.error('No access token available');
            return null;
        }
        
        function updateTrackInfo() {
            if (currentTrack) {
                document.getElementById('trackName').textContent = currentTrack.name;
                document.getElementById('artistName').textContent = currentTrack.artists.map(a => a.name).join(', ');
                document.getElementById('albumName').textContent = currentTrack.album.name;
                
                if (currentTrack.album.images.length > 0) {
                    document.getElementById('albumArt').src = currentTrack.album.images[0].url;
                }
            }
        }
        
        function updatePlaybackControls() {
            document.getElementById('playBtn').disabled = !deviceId;
            document.getElementById('pauseBtn').disabled = !deviceId;
            document.getElementById('nextBtn').disabled = !deviceId;
            document.getElementById('prevBtn').disabled = !deviceId;
            
            if (isPlaying) {
                document.getElementById('playBtn').textContent = '‚è∏Ô∏è Pause';
            } else {
                document.getElementById('playBtn').textContent = '‚ñ∂Ô∏è Play';
            }
        }
        
        function togglePlay() {
            if (deviceId) {
                if (isPlaying) {
                    player.pause();
                } else {
                    player.resume();
                }
            }
        }
        
        function pause() {
            if (deviceId) {
                player.pause();
            }
        }
        
        function nextTrack() {
            if (deviceId) {
                player.nextTrack();
            }
        }
        
        function previousTrack() {
            if (deviceId) {
                player.previousTrack();
            }
        }
        
        // Check if we have a token in the URL (after OAuth redirect)
        function checkForToken() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const token = params.get('access_token');
            const error = params.get('error');
            
            if (error) {
                console.error('OAuth error:', error, params.get('error_description'));
                updateStatus('OAuth error: ' + error, true);
                return;
            }
            
            if (token) {
                // Store token and initialize player
                localStorage.setItem('spotify_token', token);
                window.location.hash = ''; // Clear the hash
                updateStatus('Token received! Initializing player...');
                initializePlayer();
            } else {
                // Check if we have a stored token
                const storedToken = localStorage.getItem('spotify_token');
                if (storedToken) {
                    updateStatus('Using stored token. Initializing player...');
                    initializePlayer();
                } else {
                    updateStatus('Please connect to Spotify to start');
                }
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', checkForToken);
    </script>
</body>
</html> 